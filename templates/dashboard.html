{% extends "base_sidebar.html" %}

{% block title %}Dashboard - Investment Manager{% endblock %}

{% block extra_head %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .quick-stats {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .chart-section {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        border: 1px solid #dee2e6;
        margin-bottom: 2rem;
    }
    
    .calendar-section {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        border: 1px solid #dee2e6;
        margin-bottom: 2rem;
    }
</style>

<!-- PASAR DATOS DIRECTAMENTE A JAVASCRIPT -->
<script>
    window.DASHBOARD_DATA = {
        currency: {{ stats.currency_distribution | tojson | safe }},
        status: {{ stats.status_distribution | tojson | safe }},
        investments: {{ investments | tojson | safe }}
    };
    console.log('üéØ DATOS GLOBALES CONFIGURADOS:', window.DASHBOARD_DATA);
</script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="fas fa-chart-line me-2"></i>Dashboard de Inversiones</h1>
        <p class="text-muted mb-0">Resumen de tu portafolio de inversiones</p>
    </div>
    <a href="{{ url_for('create_investment') }}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>Nueva Inversi√≥n
    </a>
</div>

{% if stats %}
<!-- Estad√≠sticas R√°pidas -->
<div class="quick-stats">
    <div class="row text-center">
        <div class="col-md-3">
            <h3 class="mb-1">{{ stats.total_investments }}</h3>
            <small>Total Inversiones</small>
        </div>
        <div class="col-md-3">
            <h3 class="mb-1">{{ stats.total_amount_usd | currency('USD') }}</h3>
            <small>Total USD</small>
        </div>
        <div class="col-md-3">
            <h3 class="mb-1">{{ stats.total_amount_ars | currency('ARS') }}</h3>
            <small>Total ARS</small>
        </div>
        <div class="col-md-3">
            <h3 class="mb-1">{{ stats.active_investments }}</h3>
            <small>Inversiones Activas</small>
        </div>
    </div>
</div>

<!-- Grid de Estad√≠sticas Detalladas -->
<div class="stats-grid">
    <div class="stats-card">
        <div class="stats-value">{{ stats.estimated_return_usd | currency('USD') }}</div>
        <div class="stats-label">Rendimiento Estimado USD</div>
    </div>
    <div class="stats-card">
        <div class="stats-value">{{ stats.estimated_return_ars | currency('ARS') }}</div>
        <div class="stats-label">Rendimiento Estimado ARS</div>
    </div>
    <div class="stats-card">
        <div class="stats-value">{{ stats.in_study_investments }}</div>
        <div class="stats-label">En Estudio</div>
    </div>
    <div class="stats-card">
        <div class="stats-value">{{ stats.closed_investments }}</div>
        <div class="stats-label">Cerradas</div>
    </div>
</div>

<!-- Widget de Datos de Mercado -->
{% if market_count > 0 %}
<div class="row mb-4">
    <div class="col-12">
        <div class="chart-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="chart-title">
                    <i class="fas fa-chart-line me-2"></i>Resumen de Mercado
                    <small class="text-muted">(Google Sheets)</small>
                </h5>
                <a href="{{ url_for('market_data') }}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-external-link-alt me-1"></i>Ver Completo
                </a>
            </div>
            <div class="row text-center">
                <div class="col-md-6">
                    <div class="border-end">
                        <h4 class="text-primary mb-1">{{ market_count }}</h4>
                        <small class="text-muted">S√≠mbolos Monitoreados</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <h4 class="text-success mb-1">${{ "%.2f" | format(market_avg) }}</h4>
                    <small class="text-muted">Precio Promedio</small>
                </div>
            </div>
            <div class="mt-3">
                <small class="text-muted">
                    <i class="fas fa-sync-alt me-1"></i>
                    Datos actualizados en tiempo real desde Google Sheets
                </small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Gr√°ficos -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="chart-section">
            <h5 class="chart-title">Distribuci√≥n por Moneda</h5>
            <div class="chart-wrapper">
                <canvas id="currencyDistributionChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-section">
            <h5 class="chart-title">Distribuci√≥n por Estado</h5>
            <div class="chart-wrapper">
                <canvas id="statusDistributionChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Calendario de Inversiones -->
<div class="calendar-section">
    <h5 class="mb-3"><i class="fas fa-calendar-alt me-2"></i>Cronograma de Inversiones</h5>
    <div id="investmentCalendar"></div>
</div>
{% endif %}

<!-- Lista de Inversiones -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3><i class="fas fa-list me-2"></i>Mis Inversiones</h3>
    <div class="btn-group" role="group">
        <input type="radio" class="btn-check" name="filter" id="all" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="all">Todas</label>
        
        <input type="radio" class="btn-check" name="filter" id="active" autocomplete="off">
        <label class="btn btn-outline-success" for="active">Activas</label>
        
        <input type="radio" class="btn-check" name="filter" id="disabled" autocomplete="off">
        <label class="btn btn-outline-secondary" for="disabled">Inhabilitadas</label>
    </div>
</div>

{% if investments %}
<div class="row" id="investmentsContainer">
    {% for investment in investments %}
    <div class="col-md-6 col-lg-4 mb-4 investment-card" 
         data-status="{{ investment.status }}" 
         data-enabled="{{ investment.enabled | lower }}">
        <div class="card h-100 {% if not investment.enabled %}disabled-investment{% endif %}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ investment.name }}</h5>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('view_investment', investment_id=investment.id) }}">
                            <i class="fas fa-eye me-2"></i>Ver Detalles
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('edit_investment', investment_id=investment.id) }}">
                            <i class="fas fa-edit me-2"></i>Editar
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><button class="dropdown-item toggle-investment" data-investment-id="{{ investment.id }}">
                            {% if investment.enabled %}
                                <i class="fas fa-ban me-2 text-danger"></i>Inhabilitar
                            {% else %}
                                <i class="fas fa-check me-2 text-success"></i>Habilitar
                            {% endif %}
                        </button></li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <small class="text-muted">Organismo</small>
                    <div class="fw-bold">
                        {% if investment.organisms %}
                            <a href="{{ url_for('view_organism', organism_id=investment.organisms.id) }}" 
                               class="text-decoration-none">
                                {{ investment.organisms.name }}
                            </a>
                        {% else %}
                            {{ investment.organism or 'No especificado' }}
                        {% endif %}
                    </div>
                </div>
                
                <div class="mb-2">
                    <small class="text-muted">Tipo</small>
                    <div>
                        <span class="badge bg-secondary">{{ investment.investment_type }}</span>
                    </div>
                </div>
                
                <div class="mb-2">
                    <small class="text-muted">Estado</small>
                    <div>
                        {% if investment.status == 'activa' %}
                            <span class="badge badge-status-active">{{ investment.status | title }}</span>
                        {% elif investment.status == 'en estudio' %}
                            <span class="badge badge-status-study">{{ investment.status | title }}</span>
                        {% else %}
                            <span class="badge badge-status-closed">{{ investment.status | title }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <small class="text-muted">Monto</small>
                        <div class="fw-bold">{{ investment.amount | currency(investment.currency) }}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Moneda</small>
                        <div>{{ investment.currency }}</div>
                    </div>
                </div>
                
                {% if investment.calculation %}
                <div class="bg-light p-2 rounded mb-3">
                    <small class="text-muted">Rendimiento Estimado</small>
                    <div class="fw-bold text-success">
                        {{ investment.calculation.profit | currency(investment.currency) }}
                        <small class="text-muted">({{ investment.calculation.percentage_return }}%)</small>
                    </div>
                </div>
                {% endif %}
                
                <div class="row text-center">
                    <div class="col-6">
                        <small class="text-muted">Inicio</small>
                        <div class="small">{{ investment.start_date | date_format }}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Fin</small>
                        <div class="small">{{ investment.end_date | date_format }}</div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-grid">
                    <a href="{{ url_for('view_investment', investment_id=investment.id) }}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye me-1"></i>Ver Detalles
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
    <div class="mb-4">
        <i class="fas fa-chart-line fa-5x text-muted"></i>
    </div>
    <h3 class="text-muted">No tienes inversiones registradas</h3>
    <p class="text-muted">Comienza creando tu primera inversi√≥n para ver tu portafolio aqu√≠.</p>
    <a href="{{ url_for('create_investment') }}" class="btn btn-primary btn-lg">
        <i class="fas fa-plus me-2"></i>Crear Primera Inversi√≥n
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
console.log('üéØ DASHBOARD - USANDO window.DASHBOARD_DATA');

document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM Content Loaded - Dashboard');
    
    // Verificar datos globales
    if (!window.DASHBOARD_DATA) {
        console.error('‚ùå window.DASHBOARD_DATA no est√° definido');
        return;
    }
    
    console.log('‚úÖ Datos globales encontrados:', window.DASHBOARD_DATA);
    
    // Verificar si Chart.js est√° cargado
    if (typeof Chart === 'undefined') {
        console.error('‚ùå Chart.js NO est√° cargado');
        return;
    }
    
    console.log('‚úÖ Chart.js est√° cargado. Versi√≥n:', Chart.version);
    
    // Verificar elementos canvas
    const currencyCanvas = document.getElementById('currencyDistributionChart');
    const statusCanvas = document.getElementById('statusDistributionChart');
    
    console.log('Currency Canvas encontrado:', !!currencyCanvas);
    console.log('Status Canvas encontrado:', !!statusCanvas);
    
    // Filtros de inversiones
    const filterButtons = document.querySelectorAll('input[name="filter"]');
    const investmentCards = document.querySelectorAll('.investment-card');
    
    filterButtons.forEach(button => {
        button.addEventListener('change', function() {
            const filter = this.id;
            
            investmentCards.forEach(card => {
                const enabled = card.dataset.enabled === 'true';
                const status = card.dataset.status;
                
                let show = false;
                
                switch(filter) {
                    case 'all':
                        show = true;
                        break;
                    case 'active':
                        show = enabled && status === 'activa';
                        break;
                    case 'disabled':
                        show = !enabled;
                        break;
                }
                
                card.style.display = show ? 'block' : 'none';
            });
        });
    });
    
    // Inicializar gr√°ficos
    initCharts();
    
    // Inicializar calendario
    initCalendar();
});

function initCharts() {
    console.log('üé® INICIANDO GR√ÅFICOS');
    
    const currencyData = window.DASHBOARD_DATA.currency;
    const statusData = window.DASHBOARD_DATA.status;
    
    console.log('üìä Currency Data:', currencyData);
    console.log('üìä Status Data:', statusData);
    
    const currencyCanvas = document.getElementById('currencyDistributionChart');
    const statusCanvas = document.getElementById('statusDistributionChart');
    
    // Gr√°fico de distribuci√≥n por moneda
    if (currencyCanvas && currencyData) {
        console.log('‚úÖ Creando gr√°fico de moneda');
        
        const existingChart = Chart.getChart(currencyCanvas);
        if (existingChart) {
            existingChart.destroy();
        }
        
        try {
            new Chart(currencyCanvas, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(currencyData),
                    datasets: [{
                        data: Object.values(currencyData),
                        backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const label = context.label;
                                    return `${label}: $${value.toLocaleString()}`;
                                }
                            }
                        }
                    }
                }
            });
            console.log('üéâ Gr√°fico de moneda creado exitosamente');
        } catch (error) {
            console.error('‚ùå Error creando gr√°fico de moneda:', error);
        }
    }
    
    // Gr√°fico de distribuci√≥n por estado
    if (statusCanvas && statusData) {
        console.log('‚úÖ Creando gr√°fico de estado');
        
        const existingStatusChart = Chart.getChart(statusCanvas);
        if (existingStatusChart) {
            existingStatusChart.destroy();
        }
        
        try {
            new Chart(statusCanvas, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusData).map(key => {
                        switch(key) {
                            case 'activa': return 'Activas';
                            case 'en estudio': return 'En Estudio';
                            case 'cerrada': return 'Cerradas';
                            default: return key;
                        }
                    }),
                    datasets: [{
                        data: Object.values(statusData),
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
            console.log('üéâ Gr√°fico de estado creado exitosamente');
        } catch (error) {
            console.error('‚ùå Error creando gr√°fico de estado:', error);
        }
    }
    
    console.log('üèÅ Gr√°ficos completados');
}

function initCalendar() {
    console.log('üìÖ INICIANDO CALENDARIO');
    
    if (!window.DASHBOARD_DATA.investments) {
        console.error('‚ùå No hay datos de inversiones para el calendario');
        return;
    }
    
    // Verificar si FullCalendar est√° cargado
    if (typeof FullCalendar === 'undefined') {
        console.error('‚ùå FullCalendar NO est√° cargado');
        return;
    }
    
    console.log('‚úÖ FullCalendar est√° cargado');
    
    const calendarEl = document.getElementById('investmentCalendar');
    if (!calendarEl) {
        console.error('‚ùå Elemento del calendario no encontrado');
        return;
    }
    
    // Preparar eventos del calendario
    const events = [];
    
    window.DASHBOARD_DATA.investments.forEach(investment => {
        const baseColor = getStatusColor(investment.status);
        
        // Evento de inicio
        if (investment.start_date) {
            events.push({
                title: `üöÄ ${investment.name}`,
                start: investment.start_date,
                color: baseColor,
                textColor: 'white',
                extendedProps: {
                    type: 'start',
                    investment: investment,
                    description: `Inicio de inversi√≥n: ${investment.name}`
                }
            });
        }
        
        // Evento de finalizaci√≥n
        if (investment.end_date) {
            events.push({
                title: `üèÅ ${investment.name}`,
                start: investment.end_date,
                color: adjustColorBrightness(baseColor, -20),
                textColor: 'white',
                extendedProps: {
                    type: 'end',
                    investment: investment,
                    description: `Finalizaci√≥n de inversi√≥n: ${investment.name}`
                }
            });
        }
    });
    
    console.log('üìä Eventos del calendario preparados:', events);
    
    // Inicializar calendario
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        height: 'auto',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        buttonText: {
            today: 'Hoy',
            month: 'Mes',
            week: 'Semana',
            day: 'D√≠a',
            list: 'Lista'
        },
        dayHeaderFormat: { weekday: 'short' },
        allDayText: 'Todo el d√≠a',
        moreLinkText: 'm√°s',
        noEventsText: 'No hay eventos que mostrar',
        events: events,
        eventClick: function(info) {
            const investment = info.event.extendedProps.investment;
            const type = info.event.extendedProps.type;
            
            console.log('üîó Redirigiendo a detalles de inversi√≥n:', investment.id);
            
            // Redirigir directamente a la p√°gina de detalles de la inversi√≥n
            window.location.href = `/investment/${investment.id}`;
        },
        eventMouseEnter: function(info) {
            info.el.title = info.event.extendedProps.description;
        }
    });
    
    calendar.render();
    console.log('üéâ Calendario renderizado exitosamente');
}

function getStatusColor(status) {
    switch(status) {
        case 'activa': return '#28a745';      // Verde
        case 'en estudio': return '#ffc107';  // Amarillo
        case 'cerrada': return '#dc3545';     // Rojo
        default: return '#6c757d';            // Gris
    }
}

function adjustColorBrightness(color, amount) {
    // Funci√≥n para ajustar el brillo de un color hex
    const usePound = color[0] === '#';
    const col = usePound ? color.slice(1) : color;
    const num = parseInt(col, 16);
    
    let r = (num >> 16) + amount;
    let g = (num >> 8 & 0x00FF) + amount;
    let b = (num & 0x0000FF) + amount;
    
    r = r > 255 ? 255 : r < 0 ? 0 : r;
    g = g > 255 ? 255 : g < 0 ? 0 : g;
    b = b > 255 ? 255 : b < 0 ? 0 : b;
    
    return (usePound ? '#' : '') + (r << 16 | g << 8 | b).toString(16);
}
</script>
{% endblock %}